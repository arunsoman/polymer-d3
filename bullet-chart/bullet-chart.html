<link rel="import" href="../display-component/base-chart.html">
<dom-module id="bullet-chart">
  <template>
  <style>

    button {
      position: absolute;
      right: 10px;
      top: 10px;
    }

    .bullet { font: 10px sans-serif; }
    .bullet .marker { stroke: #000; stroke-width: 2px; }
    .bullet .tick line { stroke: #666; stroke-width: .5px; }
    .bullet .range.s0 { fill: #eee; }
    .bullet .range.s1 { fill: #ddd; }
    .bullet .range.s2 { fill: #ccc; }
    .bullet .measure.s0 { fill: lightsteelblue; }
    .bullet .measure.s1 { fill: lightblue; }
    .bullet .measure.s2 { fill: steelblue; }
    .bullet .title { font-size: 14px; font-weight: bold; }
    .bullet .subtitle { fill: #999; }

    #chartContainer{
      margin:0 auto;
    }
  </style>

    <chart-input-group uuid="[[uuid]]">
      <chart-input slot="chart-input" axis="x" label="Key"></chart-input>
      <chart-input slot="chart-input" axis="y" label="Value" accept="number"></chart-input>
    </chart-input-group>
    <chart-settings uuid="[[uuid]]"></chart-settings>
    <!-- <svg id="svg"></svg> -->
    <div id="chartContainer"></div>
  </template>
  <script>
    class bulletChart extends baseChart{
      static get is(){
        return "bullet-chart"
      }
      static get properties(){
        return{

        }
      }
      constructor(){
        super()
      }
      redraw() {
        this.draw(this._paint(this._compute()));
      }
      _compute() {
        //axis are mentioned in the chart-input module
        let itemX = this.x ? this.inputs[this.x].selectedValue : []
        let itemY = this.y ? this.inputs[this.y].selectedValue : []

        //"itemChk" for avoid error from chart
        let itemChk = itemX.length <= 0 || itemY.length <= 0

        if (itemChk) {
            return false;
        }
        //axis inputs selectedValue assigin
        itemX = itemX[0]
        itemY=itemY[0]

        let width = +this.settings.width.value,
            height = 50,
            margin = {top: 5, right: 40, bottom: 20, left: 120},
            label= this.settings.legend.values
            //margin = {top: +this.settings.margin.value.top, right: +this.settings.margin.value.right, bottom: +this.settings.margin.value.bottom, left: +this.settings.margin.value.left}
        width = width - margin.left - margin.right
        height = height - margin.top - margin.bottom

        let color = d3.scale.category20c();

        //get chart data once pass "x and y" into the "getChartData" method

        let groupedData
        let source = this.getChartData(itemX, itemY)
        groupedData = d3.nest().key(d => d.item).entries(source);

        let chartData =[]
        groupedData.map((item,idx)=>{
          let itemValues = item.values.map(test=>test.value),
              minRange = itemValues.reduce((prev,cur)=>prev < cur ? prev : cur,+Infinity),
              markers = itemValues.reduce((prev,cur)=>prev > cur ? prev : cur,-Infinity),
              midRange = Math.round(markers/2),
              maxRange = markers+minRange;
          chartData[idx]={"title":item.key,
            "ranges":[minRange,midRange,maxRange],
            "measures":item.values.map(test=>test.value),
            "markers":[markers]
          }
        })

        let chart = d3.bullet()
            .width(width)
            .height(height);

        width = width + margin.left + margin.right
        height = height + margin.top + margin.bottom

        return {
          width,
          height,
          color,
          chart,
          margin,
          itemChk,
          chartData,
          label
        }
      }
      _paint(obj) {
        d3.select(this.$.chartContainer).html("")
        if (!obj || obj.itemChk) {
          return false
        }
        var parentG = d3.select(this.$.chartContainer).selectAll("div")
            .data(obj.chartData)
            .enter().append("svg")
            .attr("class", "bullet")
            .attr("width", obj.width )
            .attr("height", obj.height)
            .append("g")
            .attr("transform", "translate(" + obj.margin.left + "," + obj.margin.top + ")")
            .call(obj.chart);

      var title = parentG.append("g")
          .style("text-anchor", "end")
          .attr("transform", "translate(-6," + obj.height / 2 + ")");

      title.append("text")
          .attr("class", "title")
          .text(function(d) { return d.title; });
      this.addLegend({
          obj,
          container:parentG,
          selector:'.measure',
          node:obj.chartData,
          key: 'date'
        });
      d3.select(this.$.chartContainer).style({"width":obj.width+"px"})
      }
      // populate chart data
      getChartData(itemX, itemY){
          let sourcemap = this.source.map(row=>{
            return{[row[itemX]]:row[itemY]}
          })
          // debugger
          let source  = sourcemap.map(items=>{return {item:Object.keys(items)[0],value:items[Object.keys(items)[0]]}})
          return source
      }
    }
    customElements.define(bulletChart.is, bulletChart)
  </script>
  <script src="bullet.js"></script>
</dom-module>
