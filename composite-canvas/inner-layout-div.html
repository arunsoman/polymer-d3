<link rel="import" href="../../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../paper-item/paper-item.html">
<!-- <link rel="import" href="../display-component/chart-holder.html"> -->
<link href="../behaviors/redux-mixins-behavior.html" rel='import'>
<link rel="import" href="recursive-elem.html">

<dom-module id="inner-layout-div">
  <template>
    <style>
      :host{
        /*min-height: 20em;*/
        min-height: 40vh;
      }
      header{
        border-bottom:1px #d3d3d3 solid;
      }
      #splitBox{
        position: relative;
        /*min-height: 10em;*/
      }
      #dropDown{
        margin-top:20px;
        border: 1px lightgrey solid;
        background-color: white;
      }
      #dropDown paper-item{
        width: 29px;
        min-height: 16px;
        cursor: pointer;
        font: 10px sans-serif;
        border-bottom: 1px lightgrey solid;
      }
      #dropDown paper-item:last-child{
        border-bottom:none;
      }
      .paperIconBtn, .addRemoveBtn{
        padding:5px;
        width: 25px;
        height: 25px;
      }
      :host #splitter{
        display:none;
      }
      paper-dialog {
        top: 5%;
        left: 2%;
        width: 90%;
        margin: 0;
        position: relative;
      }
      paper-icon-button.dialog-close {
        width: 25px;
        height: 25px;
        position: absolute;
        right: -12px;
        top: -12px;
        background: white;
        color:grey;
        border: 1px solid #ededed;
        border-radius: 50%;
        padding: 4px;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 999;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
    }
    </style>
    <div id="splitBox">
      <header>
      <paper-icon-button icon="more-horiz" slot="dropdown-trigger" on-click="showDropDown" class="paperIconBtn">select</paper-icon-button>
      <iron-dropdown horizontal-align="left" vertical-align="top" id="dropDown">
        <div slot="dropdown-content">
          <paper-item on-click="createSplitLayout" id="vert">Column</paper-item>
          <paper-item on-click="createSplitLayout" id="horz">Row </paper-item>
          <template is="dom-if" if="{{!freeze}}">
            <paper-item on-click="deleteSplitLayout" id="delete">Delete</paper-item>
          </template>
        </div>
      </iron-dropdown>
      <template is="dom-if" if="{{!showCompChart}}" restamp="true">
        <paper-icon-button icon="add" on-click="showChart" class="addRemoveBtn">Add/Remove Chart</paper-icon-button>
      </template>
      <template is="dom-if" if="{{showCompChart}}" restamp="true">
        <paper-icon-button icon="remove" on-click="removeChart" class="addRemoveBtn">Add/Remove Chart</paper-icon-button>
      </template>
      <paper-dialog id="chartSelectedModal" modal noCancelOnOutsideClick>
        <paper-icon-button icon="close" on-click="dialogClose" class="dialog-close">close</paper-icon-button>
        <chart-holder settings-visible composite-value selected-item="{{selectedItem}}"></chart-holder>
      </paper-dialog>
    </header>
    <template is="dom-if" if="[[chartAvailabilityChk(itemObj,childSource)]]" restamp="true">
      <div id="chartBox">[[itemObj.chart]]</div>
    </template>
    <template is="dom-if" if="[[childSource.length]]" restamp="true">
      <recursive-elem uuid="[[uuid]]" split-data="{{childSource}}" id="{{id}}" vertical="[[itemObj.vertical]]"></recursive-elem>
    </template>
    </div>
  </template>
  <script>
    class innerLayoutDiv extends ReduxMixinBehavior(Polymer.Element){
      static get is(){
        return "inner-layout-div"
      }
      static get properties(){
        return{
          align:{
            type:Boolean,
            notify:true
          },
          valign:{
            type:Boolean,
            value:false,
            notify:true
          },
          freeze:{
            type:String,
            value:false,
            notify:true
          },
          addRemove:{
            type:Boolean,
            value:true,
            notify:true
          },
          selectedItem:{
            type:Object,
            value:() => {return {};},
            notify:true
          },
          showCompChart:{
            type:Boolean
          },
          style:{
            type:String
          },
          chartIdChk:{
            type:Boolean,
            observer:"checkChartId"
          },
          childObj:{
            type:Object,
            value:()=>{
              return{
                "id": "",
                "vertical": false,
                "name": "",
                "freeze": false,
                "style": "ssss",
                "chart": "",
                "chartId":"",
                "showCompChart":false,
                "parent":false,
                "children": []
              }
            }
          },
          chartData:{
            type:Object,
            statePath(state){
              let chartPath = state.charts[this.uuid]
              let compositeChartData = chartPath && chartPath.compositeChartData
              return compositeChartData
            }
          },
          layoutAreaChk:{
            type:Boolean,
            statePath(state){
              let chartPath = state.charts[this.uuid]
              let layoutAreaChk = chartPath && chartPath.layoutAreaChk
              return layoutAreaChk
            }
          }

        }
      }
      static get actions() {
        return {
          addUpdateChartData(addUpdateChartData) {
            return {
              type: 'ADD_UPDATE_COMPOSITE_CHART_DATA',
              value: addUpdateChartData
            }
          },
          splitAreaChk(layoutAreaChk) {
            return {
              type: 'COMPOSITE_SPLIT_AREA_CHK',
              value: layoutAreaChk
            }
          }
        }
      }
      chartAvailabilityChk(itemObj,child){
        this.set("chartIdChk",child.length<=0 && itemObj.chart!="")
        return child.length<=0 && itemObj.chart!=""
      }
      checkChartId(chartIdChk){
        this.set("showCompChart",this.itemObj.showCompChart)
        this.setAttribute("style",this.itemObj.style)
        chartIdChk && setTimeout(()=>{
          let chart = document.createElement(this.itemObj.chart)
          chart.id=this.itemObj.chartId
          this.root.querySelector("#chartBox").appendChild(chart)
        })
      }
      showDropDown(){
        this.$.dropDown.open();
      }
      showChart() {
        this.$.chartSelectedModal.open();
        this.set("showCompChart",true)
        this.$.chartSelectedModal.backdropElement.toggleAttribute("hidden",true)
        // debugger
      }
      dialogClose(){
        this.$.chartSelectedModal.close();
        this.set("showCompChart",false)
      }
      removeChart(){
        let chartBox = this.$.splitBox.querySelector("#chartBox")
        chartBox.remove()
        this.set("showCompChart",false)
      }
      // checkDialog(){
      //
      // }
      constructor(){
        super()
      }
      createSplitLayout(e){
        let getId=this.id
        let itemId, itemId1
        let getObj = this.createNewIdNestedObj(getId)

        let parentId = getObj.parentId,
            objIdx = getObj.objIdx,
            ObjNested = getObj.ObjNested,
            parentObj = getObj.parentObj

        if(this.get(ObjNested).length==2){
          itemId = getId+"_0"
          let getNewObj = this.createNewIdNestedObj(itemId)
          ObjNested = getNewObj.ObjNested
          parentObj = getNewObj.parentObj
        } else {
          itemId = parentId+"_"+(objIdx+1)
        }
        this.set("childObj.id",itemId)
        this.push(ObjNested,this.childObj)
        let verticalKey = parentObj+".vertical",
            vertical = e.currentTarget.id=='horz'
        this.set(verticalKey,vertical)

        this.updateObjRedux()
        this.$.dropDown.close();
      }
      updateObjRedux(){
        this.dispatch("addUpdateChartData", {uuid:this.uuid,chartData:this.chartData})
        this.set("layoutAreaChk",!this.layoutAreaChk)
        this.dispatch("splitAreaChk", {uuid:this.uuid,layoutAreaChk:this.layoutAreaChk})
      }
      createNewIdNestedObj(getId){
        let splitId=getId.split("_")
        let assignId = getId.split("_")
        let splitIdSize = splitId.length
        let objIdx = (+splitId[splitIdSize-1])
        splitId.pop()
        let parentObj = splitId.join(".children."),
            parentId = splitId.join("_"),
            ObjNested = splitId.join(".children.")+".children"

        return{parentId,ObjNested,objIdx,parentObj}
      }
      deleteSplitLayout(e){
        let parentNested = this.createNewIdNestedObj(this.id).ObjNested
        let updatedObj = this.get(parentNested).filter(item=>item.id!=this.id)
        this.set(parentNested,updatedObj)
        this.updateObjRedux()
        this.$.dropDown.close();
      }
    }
    customElements.define(innerLayoutDiv.is, innerLayoutDiv)
  </script>
</dom-module>
