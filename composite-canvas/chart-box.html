<link href="../behaviors/redux-mixins-behavior.html" rel='import'>
<link href="../display-component/resizer-element.html" rel='import'>
<dom-module id="chart-box">
  <template>
    <style>
    .col-md-1,
    .col-md-10,
    .col-md-11,
    .col-md-12,
    .col-md-2,
    .col-md-3,
    .col-md-4,
    .col-md-5,
    .col-md-6,
    .col-md-7,
    .col-md-8,
    .col-md-9 {
      float: left;
      /*margin-left: 5px;
      margin-right: 5px;
      padding-left: 5px;
      padding-right: 5px;*/
      margin: 5px;
      padding: 5px;
    }

    .col-md-12 {
      width: 100%
    }

    .col-md-11 {
      width: 91.66666667%
    }

    .col-md-10 {
      width: 83.33333333%
    }

    .col-md-9 {
      width: 75%
    }

    .col-md-8 {
      width: 66.66666667%
    }

    .col-md-7 {
      width: 58.33333333%
    }

    .col-md-6 {
      width: 50%
    }

    .col-md-5 {
      width: 41.66666667%
    }

    .col-md-4 {
      width: 33.33333333%
    }

    .col-md-3 {
      width: 25%
    }

    .col-md-2 {
      width: 16.66666667%
    }

    .col-md-1 {
      width: 8.33333333%
    }
    .resize{
      resize: both;
      display: block;
      overflow: hidden;
      border-right:1px solid #f6f6f6;
      border-bottom:1px #f6f6f6 solid;
    }
    paper-button.resetBtn {
      font-size: x-small;
      float: right;
      padding: 4px;
      margin-top: 5px;
      z-index: 9;
    }
    #chartBox{
      position: relative;
      /*border-right:1px solid #f6f6f6;
      border-bottom:1px #f6f6f6 solid;*/
      border:1px solid #f6f6f6;
      /*overflow: hidden;*/
    }
    #chartBox .warningMsg.chartMsg{
      position: absolute;
      top: 43px;
      left: 12px;
      width: 100%;
    }
    paper-toggle-button.toggleBtn{
      float: right;
      font-size: x-small;
      margin-right: 10px;
      margin-top: 5px;
      z-index: 9;
      position: relative;
    }
    </style>
    <div id="chartBox" class$="[[chartData.chartCls]]" style$="height:[[chartData.chartHeight]]px">
      <paper-button raised class="resetBtn"  on-click="chartBoxRemove">Delete</paper-button>
      <paper-toggle-button class="toggleBtn" checked="{{toggle}}">RESIZE</paper-toggle-button>

      <template is="dom-if" if="{{toggle}}">
        <resizer-element resize-both element-width="{{chartDataResize.chartWidth}}" element-height="{{chartData.chartHeight}}" ></resizer-element>
      </template>
    </div>
  </template>
  <script>
    class chartBox extends ReduxMixinBehavior(Polymer.Element){
        static get is(){
          return "chart-box"
        }
        static get properties(){
          return{
            layoutData:{
              type:Array,
              statePath(state){
                let chartPath = state.charts[this.uuid]
                let layoutData = chartPath && chartPath.layoutData
                return layoutData?layoutData:[]
              }
            },
            settings: {
              type: Object,
              statePath(state) {
                if (state.charts[this.chartData.id]) {
                  return state.charts[this.chartData.id].settings
                }
              }
            },
            chartReDraw:{
              type: Boolean,
              statePath(state) {
                if (state.charts[this.chartData.id]) {
                  return state.charts[this.chartData.id].chartReDraw
                }
              }
            },
            chartsObj: {
              type: Object,
              statePath(state) {
                  return state.charts
              }
            },
            grids:{
              type:Array,
              value:[0,8.33333333,16.66666667,25,33.33333333,41.66666667,50,58.33333333,66.66666667,75,83.33333333,91.66666667,100]
            },
            toggle:{
              type:Boolean,
              value:false,
              observer:"getChartObj"
            },
            chartDataResize:{
              type:Object
            }
          }
        }
        static get actions() {
          return{
            updateLayoutItem(layoutData){
              return {
                type: 'UPDATE_LAYOUT_ITEM',
                value: layoutData
              };
            },
            updateSettings(settings){
              return {
                type: 'UPDATE_SETTINGS',
                value: settings
              };
            },
            currentChartDeleted(chartId) {
              return {
                type: 'CURRENT_CHART_DELETED',
                value: chartId
              }
            },
            chartBoxDeleted(deleteTrigger) {
              return {
                type: 'CHART_BOX_DELETED',
                value: deleteTrigger
              }
            },
            chartRedraw(chartReDraw) {
              return {
                type: 'CHART_RE_DRAW',
                value: chartReDraw
              }
            }
          }
        }
        static get observers(){
          return["onResize(chartDataResize.chartWidth)"]
        }
        constructor(){
          super()
        }
        connectedCallback(){
          super.connectedCallback()
          this.createChart()
        }
        getChartObj(){
          if(this.toggle){
            this.set("chartDataResize",this.chartData)
          }
        }
        createChart(){
          let chart = document.createElement(this.chartData.elem)
          let chartId = this.chartData.id

          if(this.chartData.chartCreate){
            chartId = this.uuid+"@_"+this.chartData.elem+"_"+this.getUUID()
            let layoutItem=this.chartData
            delete layoutItem.chartCreate
            layoutItem.id=chartId

            let layoutData = this.layoutData
            layoutData.push(layoutItem)
            this.dispatch("updateLayoutItem",{uuid:this.uuid,layoutData:layoutData})
          }
          // debugger
          chart.set("parentId",this.parentId)
          chart.set("uuid",chartId)
          chart.set("compUUID",this.uuid)
          this.$.chartBox.appendChild(chart)

          this.settingstoObj(chartId)
          // debugger
        }
        settingstoObj(chartId,resize) {
          let settings = Object.assign({},this.settings)
          settings.width.value=this.chartData.chartWidth?this.chartData.chartWidth:settings.width.value
          settings.height.value=this.chartData.chartHeight

          this.dispatch("updateSettings",{uuid:chartId,settings:settings})
          if(this.chartsObj["undefined"]){
            this.dispatch("currentChartDeleted",{uuid:"undefined"})
          }
          resize&&this.dispatch("chartRedraw",{uuid:chartId,chartReDraw:!this.chartReDraw})

          // return settings
        }
        getUUID(){
          function uuid() {
            return Math.floor((1 + Math.random()) * 0x10000)
              .toString(16)
              .substring(1);
          }
          return uuid() + uuid() + '-' + uuid() + '-' + uuid();
        }
        onResize(width){
          let grid = (width/this.parentNode.offsetWidth)*100
          let gridValue = this.grids.reduce((a,b)=>{
            return  b <= grid ? b : a
          },{})
          let gridIdx = this.grids.indexOf(gridValue)
          let resizeWidth = (this.parentNode.offsetWidth*gridValue)/100
          this.set("chartData.chartCls","col-md-"+gridIdx)
          this.set("chartDataResize.chartWidth",resizeWidth)
          if(this.layoutData){
            let layoutData = this.layoutData.map(item=>{
              if(item.id == this.chartData.id){
                item.chartWidth = this.chartData.chartWidth
                item.chartHeight = this.chartData.chartHeight
                item.chartCls = this.chartData.chartCls
              }
              return item
            })
            this.dispatch("updateLayoutItem",{uuid:this.uuid,layoutData:layoutData})
          }
          this.chartData.id&&this.settings&&this.settingstoObj(this.chartData.id,true)
        }
        chartBoxRemove(){
          this.dispatch("chartBoxDeleted",{uuid:this.chartData.id,deleteTrigger:true})
          this.remove()
        }
    }
    customElements.define(chartBox.is,chartBox)
  </script>
</dom-module>
