<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../display-component/base-chart.html">
<dom-module id="bar-chart">
  <template>
  <style>
  #chartContainer{
    margin:0 auto;
  }
  .legend-items text{
    fill:black
  }
  .legend{
    fill:transparent;
    font-size: 12px;
  }
  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
    }
  </style>
    <chart-input-group uuid="[[uuid]]">
      <chart-input slot="chart-input" axis="x" label="Key"></chart-input>
      <chart-input slot="chart-input" axis="y" label="Value" accept="number"></chart-input>
    </chart-input-group>
    <chart-settings uuid="[[uuid]]"></chart-settings>
    <div id="chartContainer"></div>
  </template>
  <script>
  /**
  * @polymer
  * @extends HTMLElement
  */
  class barChart extends baseChart {
    static get is() {
      return 'bar-chart'
    }
    static get properties() {
      return {}
    }
    redraw() {
      this.draw(this._paint(this._compute()));
    }
    _compute() {
      let axisIndex = 3
      if(!this.hasInputs(axisIndex))return false
      let margin = {
          top: 20,
          right: 50,
          bottom: 70,
          left: 150
        },
        width = this.settings.width.value - margin.left - margin.right,
        height = this.settings.height.value - margin.top - margin.bottom,
        label = this.settings.legend.values;

      let xInput = this.x ? this.inputs[this.x].selectedValue : [];
      let yInput = this.y ? this.inputs[this.y].selectedValue : [];
      let chartData = this.getChartData(xInput, yInput);

      let axis = {
        scale: {},
        position: {}
      }
      axis.scale.x = d3.scale.ordinal().rangeRoundBands([0, width], .05);
      axis.scale.y = d3.scale.linear().range([height, 0]);
      axis.scale.x.domain(chartData.map(items => items.item))
      axis.scale.y.domain([0, d3.max(chartData, items => items.value)])

      // x.domain(data.map(function(d) { return d.date; }));
      // y.domain([0, d3.max(data, function(d) { return d.value; })]);

      axis.position.x = d3.svg.axis().scale(axis.scale.x).orient("bottom");
      axis.position.y = d3.svg.axis().scale(axis.scale.y).orient("left").ticks(10);

      // this.source.map(items=>{return {item:items[xInput],value:items[yInput]}});

      return {
        width,
        margin,
        height,
        axis,
        label,
        chartData
      }

    }
    _paint(obj) {
      this.clear();
      if(!obj) return false;

      let selector = d3.select(this.$.chartContainer)
        .append("svg")
        .attr("width", obj.width + obj.margin.left + obj.margin.right)
        .attr("height", obj.height + obj.margin.top + obj.margin.bottom)

      let svg = selector.append("g")
        .attr("transform", "translate(" + obj.margin.left + "," + obj.margin.top + ")");

        svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + obj.height + ")")
        .call(obj.axis.position.x)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", "-.55em")
        .attr("transform", "rotate(-90)")
        svg.append("g")
        .attr("class", "y axis")
        .call(obj.axis.position.y)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 10)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Value ($)");

      let segments = svg.selectAll("bar")
        .data(obj.chartData)
        .enter().append("rect")
        .attr('class', 'bar')
        .style("fill", "steelblue")
        .attr("x", function(d) {
          return obj.axis.scale.x(d.item);
        })
        .attr("width", obj.axis.scale.x.rangeBand())
        .attr("y", function(d) {
          return obj.axis.scale.y(d.value);
        })
        .attr("height", function(d) {
          return obj.height - obj.axis.scale.y(d.value);
        })

      this.addLegend({
        obj,
        container:svg,
        selector:'rect.bar',
        node:obj.chartData,
        key: 'item',
        segments
      });
      // debugger;
      // this.attachToolTip(parentG, segments, 'pie-slice', htmlCallback);

    }
    getChartData(itemX, itemY) {
      let sourcemap =
        this.source.reduce((old, newVal) => {
          old[newVal[itemX]] = (old[newVal[itemX]] || 0) + newVal[itemY]
          return old
        }, {})
      let source = Object.keys(sourcemap).map(item => {
        return {
          item,
          value: sourcemap[item]
        }
      })
      return source
    }

  }
  window.customElements.define(barChart.is, barChart);
  </script>
</dom-module>
