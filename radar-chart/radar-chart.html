<link rel="import" href="../display-component/base-chart.html">
<dom-module id='radar-chart'>
  <template>
    <style>
      #chartContainer{
        margin:0 auto;
      }
    </style>
    <chart-input-group  uuid="[[uuid]]">
      <chart-input slot="chart-input" axis="x" label="Key"></chart-input>
      <chart-input slot="chart-input" axis="y" label="Value" accept="number"></chart-input>
      <chart-input slot="chart-input" axis="z" label="z-axis" accept="string"></chart-input>
    </chart-input-group>
    <chart-settings uuid="[[uuid]]"></chart-settings>
    <div id="chartContainer"></div>
  </template>
  <script>
    class radarChart extends baseChart{
      static get is(){
        return "radar-chart"
      }
      static get properties(){
        return{

        }
      }
      constructor(){
        super()
      }
      redraw() {
        this.draw(this._paint(this._compute()));
      }
      _compute() {
        //axis are mentioned in the chart-input module
        let itemX = this.x ? this.inputs[this.x].selectedValue : []
        let itemY = this.y ? this.inputs[this.y].selectedValue : []
        let itemZ = this.z ? this.inputs[this.z].selectedValue : []

        //"itemChk" for avoid error from chart
        let itemChk = itemX.length <= 0 || itemY.length <= 0 || itemZ.length<=0

        if (itemChk) {
            return false;
        }
        //axis inputs selectedValue assigin
        itemX = itemX[0]
        itemY = itemY[0]
        itemZ = itemZ[0]

        let parseDate = d3.time.format('%Y-%m-%d').parse;
        let width = +this.settings.width.value,
            height = +this.settings.height.value,
            margin = {top: 5, right: 40, bottom: 20, left: 120},
            label= this.settings.legend.values
            //margin = {top: +this.settings.margin.value.top, right: +this.settings.margin.value.right, bottom: +this.settings.margin.value.bottom, left: +this.settings.margin.value.left}
        width = width - margin.left - margin.right
        height = height - margin.top - margin.bottom

        let color = d3.scale.category10();

        //get chart data once pass "x and y" into the "getChartData" method
        let source = this.getChartData(itemX, itemY,itemZ)
        let chartData = source.data
        let KeyMap = source.KeyMap

        //Options for the Radar chart, other than default
        let options = {
          width: width,
          height: height,
          maxValue: 0.6,
          levels: 6,
          ExtraWidthX: (margin.left + margin.right),
          ExtraHeightY: (margin.top + margin.bottom),
          color:color
        }

        return {
          width,
          height,
          margin,
          itemChk,
          chartData,
          options,
          KeyMap,
          color,
          label
        }
      }
      _paint(obj) {
        d3.select(this.$.chartContainer).html("")
        if (!obj || obj.itemChk) {
          return false
        }
        //Draw Radar chart
        let parentG = this.$.chartContainer
        chart.radarChart(parentG,obj.chartData,obj.options)
        //Draw Radar chart legend
        var svg = d3.select(parentG)
                  	.selectAll('svg')
                  	.append('svg')
                  	.attr("width", obj.width+obj.options.ExtraWidthX)
                  	.attr("height", obj.height)

        //Create the title for the legend
        var text = svg.append("text")
                    	.attr("class", "title")
                    	.attr('transform', 'translate(90,0)')
                    	.attr("x", obj.width - 70)
                    	.attr("y", 10)
                    	.attr("font-size", "12px")
                    	.attr("fill", "#404040")
                    	.text("test legend");

        //Initiate Legend

        // this.addLegend({
        //     obj,
        //     container:svg,
        //     selector:'.dot',
        //     node:obj.KeyMap
        //   });
        var legend = svg.append("g")
                      	.attr("class", "legend")
                      	.attr("height", 100)
                      	.attr("width", 200)
                      	.attr('transform', 'translate(90,20)')

      	//Create colour squares
      	legend.selectAll('rect')
          	  .data(obj.KeyMap)
          	  .enter()
          	  .append("rect")
          	  .attr("x", obj.width - 65)
          	  .attr("y", function(d, i){ return i * 20;})
          	  .attr("width", 10)
          	  .attr("height", 10)
          	  .style("fill", function(d, i){ return obj.color(i);})
      	//Create text next to squares
      	legend.selectAll('text')
          	  .data(obj.KeyMap)
          	  .enter()
          	  .append("text")
          	  .attr("x", obj.width - 52)
          	  .attr("y", function(d, i){ return i * 20 + 9;})
          	  .attr("font-size", "11px")
          	  .attr("fill", "#737373")
          	  .text(function(d) { return d; })
        d3.select(parentG).style({"width":obj.width+ obj.options.ExtraWidthX+"px"})
      }
      // populate chart data
      getChartData(itemX, itemY,itemZ){
        let formatDate = d3.time.format("%Y-%m-%d").parse;
        let keys=this.source.map(row=>row[itemZ])
        let KeyMap = keys.filter((item, pos)=>keys.indexOf(item) == pos)
        let dateChk
        let sourceData= KeyMap.map((key,i)=>{
          return this.source.reduce((old,newD)=>{
              if(!old[key]){
                if(newD[itemZ] == key){old[key]=[newD]}
              }else{
                newD[itemZ] == key&& old[key].push(newD)
              }
              return old
           },{})
        })
        let data = sourceData.map((items,i)=>{
          let clsName = KeyMap[i]
          return items[clsName].map(item=>{
              let dateV = String(item[itemX]).split(" ")[0]
              dateChk = formatDate(dateV)
              let dateSet = dateChk?dateV:item[itemX]
              return{
                axis:dateSet,
                value:item[itemY]
              }
            })
        })
        return{data,KeyMap}
      }
    }
    customElements.define(radarChart.is, radarChart)
  </script>
  <script src='RadarChart.js'></script>
</dom-module>
