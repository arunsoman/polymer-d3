<link rel="import" href="chart-input.html"/>
<link rel="import" href="drag-element.html"/>
<link href="../behaviors/redux-mixins-behavior.html" rel='import'>
<dom-module id="chart-input-group">
  <template>
    <style>
    :host{
      position: relative;
    };
      .input-drag-wrapper{
        padding: 1em;
      }
      #chartSelector{
        position: relative;
        background: #2196f3;
        text-align: center;
        margin: 0;
        padding: 0;
      }
      .input-drag-wrapper{
        padding: 1em 1em 0;
      }
      #inputItems{
        background: #fff;
        margin-top: 7px;
      }
      paper-dialog{
        min-width: 710px;
      }
      paper-tabs{
        background: #45c1e0;
        /*margin-bottom: 0;*/
        margin-top: 0;
      }
      paper-tabs[no-bar] paper-tab.iron-selected {
        color: #ffff8d;
      }
      .chart-wrapper{
        overflow: auto;
        resize: both;
        border: dotted 3px red;
        position: absolute;
      }
      .chart-wrapper:active{
        width: 0;
        height: 0;
      }
      .margin-wrapper{
        position: absolute;
      }
      .canvas-resizer{
        position: relative;
      }
      paper-icon-button.settings{
        float:right;
        color: #9f9e9e;
        width: 36px;
        height: 36px;
        margin-top: 1px;
      }

    </style>

    <paper-icon-button icon="icons:settings" on-click="showChartOptions" class="settings"></paper-icon-button>
    <template is="dom-if" if="{{live}}">
      <button on-tap="toggleEdit">Exit live edit</button>
        <paper-radio-group selected="{{live}}" attr-for-selected="name">
          <paper-radio-button name="canvas">Canvas</paper-radio-button>
          <paper-radio-button name="margin">Margin</paper-radio-button>
          <paper-radio-button name="legend">Legend</paper-radio-button>
          <paper-radio-button name="xLabel"> X Label</paper-radio-button>
          <paper-radio-button name="yLabel"> Y Label</paper-radio-button>
          <paper-radio-button name="zLabel"> Z Label</paper-radio-button>
      </paper-radio-group>
      <template is="dom-if" if="{{eq(live,'canvas')}}">
        <div class="canvas-resizer" style$="left:[[newSettings.margin.value.left]]px; top:[[newSettings.margin.value.top]]px;">
            <resizer-element resize-both show-info element-width="{{newSettings.width.value}}" element-height="{{newSettings.height.value}}" mouseup-callback="{{updateCallback}}"></resizer-element>
        </div>
      </template>
      <template is="dom-if" if="{{eq(live,'margin')}}">
      <div class="margin-wrapper" style$="width:[[newSettings.width.value]]px; height: [[newSettings.height.value]]px; ">
        <resizer-element element-align="left" margin-value="{{newSettings.margin.value.left}}"></resizer-element>
        <resizer-element element-align="top" margin-value="{{newSettings.margin.value.top}}"></resizer-element>
        <resizer-element element-align="right" margin-value="{{newSettings.margin.value.right}}"></resizer-element>
        <resizer-element element-align="bottom" margin-value="{{newSettings.margin.value.bottom}}"></resizer-element>
      </div>

      </template>
      <template is="dom-if" if="{{eq(live,'legend')}}">
        <div class="legend-drop-target">Legend position tracker</div>
      </template>
    </template>
    <paper-dialog id="chartSelectorModal" with-backdrop>

    <paper-tabs selected="{{selected}}" no-bar>
      <paper-tab>Chart Source</paper-tab>
      <paper-tab>Edit</paper-tab>
    </paper-tabs>
      <iron-pages selected="{{selected}}">
        <div>
         <div id="chartSelector">
          <div class="input-drag-wrapper">
            <template is="dom-repeat" items="[[ externals ]]">
              <drag-element item="[[item]]" draggable="true"  data-index$="[[item.value]]"></drag-element>
            </template>
          </div>

          <div id="inputItems">
            <slot name="chart-input"></slot>
          </div>
        </div>
      </div>

      <div>
          <chart-settings uuid="[[uuid]]" live="{{live}}"></chart-settings>
      </div>
    </iron-pages>
  </paper-dialog>
</template>

<script>

  class chartInputGroup extends ReduxMixinBehavior(Polymer.Element) {
    static get is() {
      return 'chart-input-group';
    }
    static get properties(){
      return{
        uuid:{
          type:String,
          observer:'init'
        },
        paragraphId:{
          type:String
        },
        externals:{
          type:Array,
          statePath(state){
            if(this.paragraphId){
              return state.data[this.paragraphId].externals;
            }
          }
        },
        live:{
          type:Boolean,
          value:false,
          observer:'liveEdit'
        },
        selected:{
          type:Number,
          value:0,
          observer:'tabChange'
        },
        source:{
          type:Array,
          statePath(state){
            if(this.paragraphId){
              return state.data[this.paragraphId].source
            }
          }
        },
        updateCallback:{
          type:Number,
          observer:'applySettings'
        },
        settings:{
          type:Object,
          statePath(state){
            if(this.uuid && state.charts[this.uuid]){
              return state.charts[this.uuid].settings
            }
          }
        }
      }
    }
    static get actions() {
      return {
        updateExternal(externals) {
          return {
            type: 'UPDATE_EXTERNALS',
            value: externals
          };
        },
        updateSource(source) {
          return {
            type: 'UPDATE_SOURCE',
            value: source
          };
        }
      }
    }
    eq(object, args) {
      return object == args
    }
    applySettings(){
      let newSettings = Object.assign({},this.newSettings);
      this.dispatch({
        type: 'UPDATE_SETTINGS',
        value: {
          id: this.uuid,
          settings: newSettings
        }
      })
    }
    eq(data,val){
      return data == val;
    }
    toggleEdit(){
      this.set('live',!this.live);
    }
    liveEdit(){
      this.$.chartSelectorModal.close();
      this.newSettings = Object.assign({},this.settings);
    }
    tabChange(){
      this.$.chartSelectorModal.notifyResize();
    }
    showChartOptions(){
      this.$.chartSelectorModal.open();
    }

    init(){
      this.set('paragraphId',this.uuid.split('@')[0]);
    }
    constructor() {
      super();
    }
    connectedCallback(){
      super.connectedCallback();
    }
  }
  customElements.define(chartInputGroup.is, chartInputGroup)
</script>
</dom-module>
