<link rel="import" href="chart-input.html"/>
<link rel="import" href="drag-element.html"/>
<link href="../behaviors/redux-mixins-behavior.html" rel='import'>
<dom-module id="chart-input-group">
  <template>
    <style>
      .input-drag-wrapper{
        padding: 1em;
      }
      #chartSelector{
        position: relative;
        background: #2196f3;
        text-align: center;
        margin: 0;
        padding: 0;
      }
      .input-drag-wrapper{
        padding: 1em 1em 0;
      }
      #inputItems{
        background: #fff;
        margin-top: 7px;
      }
      paper-dialog{
        min-width: 710px;
      }
      paper-tabs{
        background: #45c1e0;
        /*margin-bottom: 0;*/
        margin-top: 0;
      }
      paper-tabs[no-bar] paper-tab.iron-selected {
        color: #ffff8d;
      }
      .chart-wrapper{
        overflow: auto;
        resize: both;
        border: dotted 3px red;
        position: absolute;
      }
      .chart-wrapper:active{
        width: 0;
        height: 0;
      }

    </style>

    <paper-icon-button icon="icons:settings" on-click="showChartOptions"></paper-icon-button>
    <template is="dom-if" if="{{live}}">
      <button on-tap="toggleEdit">Exit live edit</button>
      <resizer-element resize-both element-width="{{newSettings.width.value}}" element-height="{{newSettings.height.value}}" update-callback="{{updateCallback}}"></resizer-element>
    </template>
    <paper-dialog id="chartSelectorModal" with-backdrop>

    <paper-tabs selected="{{selected}}" no-bar>
      <paper-tab>Chart Source</paper-tab>
      <paper-tab>Settings</paper-tab>
    </paper-tabs>
      <iron-pages selected="{{selected}}">
        <div>
         <div id="chartSelector">
          <div class="input-drag-wrapper">
            <template is="dom-repeat" items="[[ externals ]]">
              <drag-element item="[[item]]" draggable="true"  data-index$="[[item.value]]"></drag-element>
            </template>
          </div>

          <div id="inputItems">
            <slot name="chart-input"></slot>
          </div>
        </div>
      </div>
      
      <div>
          <chart-settings uuid="[[uuid]]" live="{{live}}"></chart-settings>
      </div>
    </iron-pages>
  </paper-dialog>
</template>

<script>

  class chartInputGroup extends ReduxMixinBehavior(Polymer.Element) {
    static get is() {
      return 'chart-input-group';
    }
    static get properties(){
      return{
        uuid:{
          type:String,
          observer:'init'
        },
        paragraphId:{
          type:String
        },
        externals:{
          type:Array,
          statePath(state){
            if(this.paragraphId){
              return state.data[this.paragraphId].externals;
            }
          }
        },
        live:{
          type:Boolean,
          value:false,
          observer:'liveEdit'
        },
        selected:{
          type:Number,
          value:0,
          observer:'tabChange'
        },
        source:{
          type:Array,
          statePath(state){
            if(this.paragraphId){
              return state.data[this.paragraphId].source
            }
          }
        },
        updateCallback:{
          type:Number,
          observer:'applySettings'
        },
        settings:{
          type:Object,
          statePath(state){
            if(this.uuid){
              return state.charts[this.uuid].settings
            }
          }
        }
      }
    }
    static get actions() {
      return {
        updateExternal(externals) {
          return {
            type: 'UPDATE_EXTERNALS',
            value: externals
          };
        },
        updateSource(source) {
          return {
            type: 'UPDATE_SOURCE',
            value: source
          };
        }
      }
    }
    applySettings(){
      let newSettings = Object.assign({},this.newSettings);
      this.dispatch({
        type: 'UPDATE_SETTINGS',
        value: {
          id: this.uuid,
          settings: newSettings
        }
      })
    }
    toggleEdit(){
      this.set('live',!this.live);
    }
    liveEdit(){
      this.$.chartSelectorModal.close();
      this.newSettings = Object.assign({},this.settings);
    }
    tabChange(){
      this.$.chartSelectorModal.notifyResize();
    }
    showChartOptions(){
      this.$.chartSelectorModal.open();
    }

    init(){
      this.set('paragraphId',this.uuid.split('@')[0]);
    }
    constructor() {
      super();
    }
    connectedCallback(){
      super.connectedCallback();
    }
  }
  customElements.define(chartInputGroup.is, chartInputGroup)
</script>
</dom-module>
