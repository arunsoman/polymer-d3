<!--Abstracts drag and drop feature-->
<!-- <link rel="import" href="../bower_components/polymer-sortablejs/polymer-sortablejs.html"> -->
<!-- <link rel="import" href="draggable-element.html"> -->
<!-- <link rel="import" href="../behaviors/draggable-behavior.html"> -->
<dom-module id="draggable-input">
  <template>
  <style>
  .input-drag-wrapper{
  padding: 1em;
}
:host{
    position: relative;
    overflow: hidden;
    background: #2f3238;
    border-bottom: solid 1px #c71503;
    display: block;
    overflow: hidden;
}
.input-drag-wrapper{
  padding: 1em;
}
#inputItems{
  background: #cc6055;
}
.item-holder{
    width: 33%;
    display: inline-block;
    padding: 1em;
    box-sizing: border-box;
    text-align: left;
    position: relative;
    transform: scale3d(1,1,1);
    transition: all .2s linear;
}
.item-holder p{
  margin: 0;
  font-size: 0.8em;
  color: #23d9a2;
}

.item-holder:after{
    content: "";
    display: none;
    right: 0;
    top: 0;
    bottom: 0;
    position: absolute;
    background: rgba(0,0,0,0);
    z-index: 1;
    left: 0;
}
:host .drag-active .item-holder:after{
  display: block;
}
.item-holder.hover{
  transform: scale3d(1.1,1.1,1);
}
h4{
    margin-top: 0.5em;
    color: #2f3238;
    margin-bottom: 0;
}
.item-drop{
    background: rgba(255,255,255,1);
    padding: 1em;
    min-height: 50px;
    vertical-align: middle;
    color: #7d443e;
    border-radius: 4px;
    position: relative;
    box-shadow: 1px 1px 5px 0px rgba(0,0,0,0.1);
}

.item-drop:after{
  position: absolute;
    top: 30%;
    left: 0;
    width: 100%;
    color: rgba(0,0,0,0.15);
    font-size: 2em;
    font-family: arial;
    pointer-events: none;
    content: "+";
    text-align: center;
}
.tags{
    cursor: move;
    padding: 0.5em 1em;
    display: inline-block;
    background: #23d9a2;
    border-radius: 4px;
    color: #ffffff;
    margin-bottom: 0.2em;
    overflow: hidden;
    position: relative;
}
.tags:hover{
  background: #c38983;
}

.item-drop ::content .tags{
  background: #2f3238;
  color: #bdb0af;
  cursor: default;
}
.item-drop ::content .tags:hover{
  background: #7d413a;
}
.tags small {
    font-size: 0.5em;
    display: block;
    color: #000;
}
.item-drop .tags i{
    position: absolute;
    right: 0;
    top: 0;
    background: rgba(0,0,0,0.5);
    margin-top: -0.1em;
    transition: all .2s linear;
    left: 0;
    text-align: center;
    opacity: 0;
}
.item-drop .tags:hover i{
    opacity: 1
}
  </style>

    <!-- <div uuid = [[getUUID]]></div> -->
    <div class="input-drag-wrapper">
    <template is="dom-repeat" items="[[ externals ]]">
      <span class="tags" draggable="true"  data-index$="[[item.value]]">
        [[ item.key ]]
        <small>[[ item.type ]]</small>
      </span>
    </template>
  </div>
    <!-- <div class="external-items">
        <template is="dom-repeat" items={{externals}}>
          <div data-item="{{item}}" draggable="true" class$="list-item {{item.type}}">
            {{item.key}}
          </div>
        </template>
    </div> -->

    <!-- <div class="sortable-wrap master-wrap" id="master-holder">
      <sortable-js id="master">
            <paper-icon-button icon="[[_generateIcon(item.type)]]"></paper-icon-button>
          </div>
        </template>
      </sortable-js>
    </div> -->
    <div id="inputItems">
      <template is="dom-repeat" items="{{ inputs }}" as="input">
        <div class="item-holder" on-drop="drop" on-dragover="allowDrop" on-dragleave="dragLeave">
          <div class="item-drop">
            <template is="dom-repeat" items="{{ input.selectedObjs }}" as="tag" index-as="tagIndex">
              <span class="tags">[[ tag.key ]] <i><paper-icon-button icon="delete" on-tap="removeTag" index="{{index}}"></paper-icon-button></i></span>
            </template>
          </div>
          <h4>[[ input.txt ]]</h4>
          <p>Accepts srings / number</p>
        </div>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: 'draggable-input',
      properties: {
        inputs: {
          value: () => { return [];},
          notify: true,
          type: Array
        },
        externals: {
          value: [],
          notify: true,
          type: Array
        },
        group: {
          type: Object,
          value: () => {return {};}
        },
        parentElem: {
          type: Object,
          value: () => {return {};}
        }
      },

      observers: ['_inputsObserver(inputs)', '_externalsObs(externals)'],
      listeners: {
        'dragstart': 'drag'
      },
      _externalsObs: function(externals) {
        console.log('externals');
        if (externals.length) {
          this._externals = PolymerD3.utilities.clone(externals);
        }
      },
      drag: function(e){
          if(!e.target.dataset) return;
          this.$.inputItems.classList.add('drag-active');
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text",e.target.dataset.index);
      },
      dragLeave: function(e){
        e.target.classList.remove('hover');
      },
      allowDrop: function(e){
        e.target.classList.add('hover');
        e.preventDefault();
      },
      drop: function(e){
        e.preventDefault();
        this.$.inputItems.classList.remove('drag-active');
        var tagIndex = e.dataTransfer.getData('text');
        if(tagIndex){
          e.target.classList.remove('hover');
          this.addTag(e.model.index,tagIndex);
          e.dataTransfer.clearData('text');
        }
      },
      addTag: function(nodeIndex,tagIndex){
          var tagNode = this.externals[tagIndex];
          if(!this.hasDuplicateTag(nodeIndex,tagNode)){
            this.push('inputs.'+nodeIndex+'.selectedObjs',tagNode);
            this.push('inputs.'+nodeIndex+'.selectedValue',tagNode.value);
          }
      },
      hasDuplicateTag: function(index,node){
        var getIndex = this.inputs[index].selectedObjs.indexOf(node)
        return (getIndex < 0) ? false : true ;
      },
      _inputsObserver: function(inputs) {
        if (inputs.length && inputs.length > 0) {
          this.async(() => {
            var slaves = this.querySelectorAll('.slaves');
            for (var i = 0; i < slaves.length; i++) {
              slaves[i].group = {
                name: this.uuid
              };
              // For manual delete
              slaves[i].addEventListener('itemSpliced', this._fireRem.bind(this));
            }
          });
        }
      },

      attached: function() {

      },
      removeTag: function(e){
        this.splice('inputs.'+e.model.index+'.selectedObjs',e.model.tagIndex,1);
        this.splice('inputs.'+e.model.index+'.selectedValue',e.model.tagIndex,1);
      }

    });
  </script>
</dom-module>
