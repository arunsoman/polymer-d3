<link rel="import" href="../display-component/base-chart.html">
<!-- <link href="../behaviors/redux-mixins-behavior.html" rel='import'> -->
<dom-module id="pie-chart">
<template>

  <chart-input-group  uuid="[[uuid]]">
    <chart-input slot="chart-input" axis="x" label="x-axis"></chart-input>
    <chart-input slot="chart-input" axis="y" label="y-axis"></chart-input>
    <chart-input slot="chart-input" axis="groupBy" label="Group by"></chart-input>
  </chart-input-group>
  <chart-settings uuid="[[uuid]]"></chart-settings>
  <svg id="svg"></svg>
</template>
<script>

  class pieChart extends baseChart{
    static get is(){ return 'pie-chart'}


    static get properties(){
      return{
        innerRadius:{
          type:Object,
          value:{
            selectedValue: 0
          }
        }
      }
    }

    constructor(){
      super();
    }

    redraw(){
      this.draw(this._paint(this._compute()));
    }

    _dispatchObj(){
      let self = this
      let chartProperies={}
      let id= this.uuid
      let settings=this.settings
      let inputs = this.inputs
      let redrawChk = this.redrawChk
      // chartProperies= {id,settings,redrawChk,inputs}
      // this.dispatch("updateChart",chartProperies)

    }
    _compute(){

      //axis are mentioned in the chart-input module
      let itemGrpX = this.x && this.inputs[this.x].itemGrp
      let itemGrpY = this.y && this.inputs[this.y].itemGrp
      let groupBy = this.groupBy && this.inputs[this.groupBy].itemGrp

      if (!itemGrpX || !itemGrpY ) {
        if(!groupBy){
          return false;
        }
      }
      let width = this.settings.width.value,
          height = this.settings.height.value,
            radius = Math.min(width, height) / 2;

        let innerRadius = this.innerRadius.selectedValue;

        let color = d3.scale.category20c();
        // let color = d3.scaleOrdinal(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
        // let color = d3.scaleOrdinal()

        //get chart data once pass "itemGrp" into the "getChartData" method
        let itemGrp
        let itemGrpChk = !groupBy || groupBy.length<=0

        //"itemChk" for avoid error from chart
        let itemChk = itemGrpChk?itemGrpX.length<=0 || itemGrpY.length<=0:itemGrpChk

        itemGrp = itemGrpChk?itemGrpX.concat.apply(itemGrpX,itemGrpY):groupBy

        let groupedData
        let source = this.getChartData(itemGrp)
        if (itemGrpChk) {
            groupedData = d3.nest().key(d => d).entries(source);
        } else {
            groupedData = d3.nest().key(d => d.item).entries(source);
        }

        let pie = d3.layout.pie()
            .value(d=>d.value)
            .sort(null);

        let arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(innerRadius);

        let labelArc = d3.svg.arc()
            .outerRadius(radius - 40)
            .innerRadius(radius - 40);

        return { width, height, color, arc, pie, itemChk, itemGrpChk,groupedData}
    }
    _paint(obj) {
      // this.parentG = d3.select("svg")

      let parentG = d3.select(this.$.svg)
      if(parentG){
        parentG.html("")
      }

      if(!obj || obj.itemChk){
        return false
      }
      if(this.$.svg){
        this.$.svg.setAttribute("width",obj.width)
        this.$.svg.setAttribute("height",obj.height)
      }

      let self = this
      parentG.data(obj.groupedData).enter()
      let g = parentG.selectAll('.arc')
          .data(d=>obj.pie(d.values))
          .enter().append('g')
          .attr('class', 'arc');

      let segments = g.append('path')
          .attr('d', obj.arc)
          .style('fill', function(d) {
              return obj.color(d.data.value);
          })
          .attr('class', 'pie-slice');

    segments.attr('transform', 'translate(' + obj.width / 2 + ',' + obj.height / 2 + ')');

      let htmlCallback = d => {
          // temp. setup to check if grouping works
          // console.log("-d.data--",d.data)
          // let gpName = d.data.groupName || d.data[this.inputs[this.y].selectedValue[0]];
          let gpName = d.data.groupName || d.data.item;
          let str = '<table class="pie-tooltip">' +
              '<tr>' +
              '<td>' + d.data.value + ',</td>' +
              '<td>' + gpName + '</td>' +
              '</tr>' +
              '</table>';
          return str;
        };
        this.attachToolTip(parentG, segments, 'pie-slice', htmlCallback);
    }

  }
  customElements.define(pieChart.is,pieChart)

</script>
</dom-module>
