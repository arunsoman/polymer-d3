<link rel="import" href="../display-component/base-chart.html">
<!-- <link href="../behaviors/redux-mixins-behavior.html" rel='import'> -->
<dom-module id="pie-chart">
<template>
  <chart-input-group  uuid="[[uuid]]">
    <chart-input slot="chart-input" axis="x" label="x-axis"></chart-input>
    <chart-input slot="chart-input" axis="y" label="y-axis"></chart-input>
  </chart-input-group>
  <h3>[[settings.title]]</h3>
  <chart-legend></chart-legend>
  <chart-settings></chart-settings>
  <svg id="svg"></svg>
</template>
<script>

  class pieChart extends baseChart{
    static get is(){ return 'pie-chart'}

    static get properties(){
      return{
        chartWidth:{
          type:Number,
          value:960
        },
        chartHeight:{
          type:Number,
          value:500
        },
        innerRadius:{
          type:Object,
          value:{
            selectedValue: 0
          }
        }
      }
    }

    constructor(){
      super();
    }
    connectedCallback(){
      super.connectedCallback()
      this._dispatchObj()
    }
    redraw(){
      this.draw(this._paint(this._compute()));
    }

    _dispatchObj(){
      let self = this
      let chartProperies={}
      let id= this.uuid
      let settings=this.settings
      let inputs = this.inputs
      let redrawChk = this.redrawChk
      chartProperies= {id,settings,redrawChk,inputs}
      this.dispatch("updateChart",chartProperies)

    }
    _compute(){
      // debugger
      //axis are mentioned in the chart-input module
      let slice = this.x && this.inputs[this.x].selectedValue
      let sliceSize = this.y && this.inputs[this.y].selectedValue

        // if slice exists, it would be an array
        if (!slice || !sliceSize ) {
            return false;
        }
        let selectedValueChk = slice.length<=0 || sliceSize.length<=0

        let groupBy = this.group && this.inputs[this.groupBy].selectedValue
        slice = slice[0];
        sliceSize = sliceSize[0];

        let width = this.chartWidth,
            height = this.chartHeight,
            radius = Math.min(width, height) / 2;

        let innerRadius = this.innerRadius.selectedValue;

        let color = d3.scale.category20c();
        // let color = d3.scaleOrdinal(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
        // let color = d3.scaleOrdinal()

        let pie = d3.layout.pie()
            .sort(null)
            .value(function(d) {
                return d[sliceSize];
            });

        let arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(innerRadius);

        let labelArc = d3.svg.arc()
            .outerRadius(radius - 40)
            .innerRadius(radius - 40);

        let groupedData;
        if (!groupBy) {
            groupedData = d3.nest().key(d => d).entries(this.source);
        } else {
            groupedData = d3.nest().key(d => d[groupBy]).entries(this.source);
        }

        return {slice, width, height, color, arc, pie, selectedValueChk}
    }
    _paint(obj) {
      // this.parentG = d3.select("svg")

      let parentG = d3.select(this.$.svg)
      if(parentG){
        parentG.html("")
      }

      if(!obj || obj.selectedValueChk){
        return false
      }
      if(this.$.svg){
        this.$.svg.setAttribute("width",obj.width)
        this.$.svg.setAttribute("height",obj.height)
      }

      let self = this
      let g = parentG.selectAll('.arc')
          .data(obj.pie(self.source))
          .enter().append('g')
          .attr('class', 'arc');

      let segments = g.append('path')
          .attr('d', obj.arc)
          .style('fill', function(d) {
              return obj.color(d.data[obj.slice]);
          })
          .attr('class', 'pie-slice');

    segments.attr('transform', 'translate(' + obj.width / 2 + ',' + obj.height / 2 + ')');

      let htmlCallback = d => {
          // temp. setup to check if grouping works
          let gpName = d.data.groupName || d.data[this.inputs[this.y].selectedValue[0]];
          let str = '<table class="pie-tooltip">' +
              '<tr>' +
              '<td>' + d.data[this.inputs[this.x].selectedValue[0]] + ',</td>' +
              '<td>' + gpName + '</td>' +
              '</tr>' +
              '</table>';
          return str;
        };
        this.attachToolTip(parentG, segments, 'pie-slice', htmlCallback);
    }

  }
  customElements.define(pieChart.is,pieChart)

</script>
</dom-module>
