<link rel="import" href="chart-input.html">
<dom-module id="pie-chart">
<template>
  <h3>[[settings.title]]</h3>
  <chart-input axis="{{x}}"></chart-input>
  <chart-input axis="{{y}}"></chart-input>
  <chart-legend></chart-legend>
  <chart-settings></chart-settings>
</template>
<script>
  class pieChart extends baseChart(){
    static get is(){ return 'pie-chart'}

    static get properties(){
      return{
        inputs:{
          type:Array,
          statePath:function(a,b){
            let store = store.getStore();
            return store.charts[id].input
          }()
        }
      }
    }
    constructor(){
      super();
    }
    attached(){
      redraw();
    }
    redraw(){
      draw(_paint(_compute()));
    }
    _compute(){
      let slice = this.inputs[0].selectedValue;
        let sliceSize = this.inputs[1].selectedValue;
        // if slice exists, it would be an array
        if (!slice || !sliceSize) {
            return false;
        }
        let groupBy = this.inputs[2].selectedValue;
        slice = slice[0];
        sliceSize = sliceSize[0];

        let width = this.chartWidth,
            height = this.chartHeight,
            radius = Math.min(width, height) / 2;
        let innerRadius = this.area[6].selectedValue;

        let color = d3.scale.category20c();

        let arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(innerRadius);

        let labelArc = d3.svg.arc()
            .outerRadius(radius - 40)
            .innerRadius(radius - 40);

        let groupedData;
        if (!groupBy) {
            groupedData = d3.nest().key(d => d).entries(this.source);
        } else {
            groupedData = d3.nest().key(d => d[groupBy]).entries(this.source);
        }
        let pie = d3.layout.pie()
            .sort(null)
            .value(function(d) {
                return d[sliceSize];
            });
        return width, height, pie, arc, slice, color
    }
    _paint(width, height, pie, arc, slice, color) {
      this.parentG.attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');
        let me = this;
        if (this.parentG) {
            this.parentG.html('');
        }
        let g = this.parentG.selectAll('.arc')
            .data(pie(me.source))
            .enter().append('g')
            .attr('class', 'arc');

        let segments = g.append('path')
            .attr('d', arc)
            .style('fill', function(d) {
                return color(d.data[slice]);
            })
            .attr('class', 'pie-slice');
        
        let htmlCallback = d => {
            // temp. setup to check if grouping works
            let gpName = d.data.groupName || d.data[this.inputs[1].selectedValue[0]];
            let str = '<table class="pie-tooltip">' +
                '<tr>' +
                '<td>' + d.data[this.inputs[0].selectedValue] + ',</td>' +
                '<td>' + gpName + '</td>' +
                '</tr>' +
                '</table>';
            return str;
        };
        // attachToolTip: (parentG, elem, customClass, htmlCallback) => {
        this.attachToolTip(this.parentG, segments, 'pie-slice', htmlCallback);
    }
  }
  window.CustomElements.define(pieChart.is,pieChart)

</script>
</dom-module>
