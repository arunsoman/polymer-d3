<link rel="import" href="../display-component/base-chart.html">
<dom-module id='calendar-chart'>
  <style>
    .arc text {
      font: 10px sans-serif;
      text-anchor: middle;
    }

    .arc path {
      stroke: #fff;
    }

    .chartContainer {
      max-width: 100%;
    }
    .draggable-areabtn-wrap {
      position: relative;
    }
    .icons-wrap.right-icons,
    .settings-icon {
      position: absolute;
      right: 1em;
      top: 6px;
    }
    paper-icon-button {
     color: #868686;
     transition: all .3s ease;
    }
    paper-icon-button:hover {
      color: #454545;
    }
    .pie-slice {
      transition: all .2s ease-in;
    }
    .pie-slice:hover {
      -webkit-filter: drop-shadow( -5px -5px 5px #000);
      filter: drop-shadow( -5px -5px 5px #000);
      transform: scale(1.05);
    }
  </style>

  <template>
    <chart-input-group  uuid="[[uuid]]">
      <chart-input slot="chart-input" axis="x" label="x-axis"></chart-input>
      <chart-input slot="chart-input" axis="y" label="y-axis"></chart-input>
    </chart-input-group>
    <chart-settings uuid="[[uuid]]"></chart-settings>
    <!-- <svg id="svg"></svg> -->
    <div id="chartContainer"></div>
  </template>
  <script>
    class calendarChart extends baseChart{
      static get is(){
        return "calendar-chart"
      }
      static get properties(){
        return{

        }
      }
      constructor(){
        super()
      }
      redraw() {
        this.draw(this._paint(this._compute()));
      }
      _compute() {
        //axis are mentioned in the chart-input module
        let itemGrpX = this.x ? this.inputs[this.x].itemGrp : []
        let itemGrpY = this.y ? this.inputs[this.y].itemGrp : []
        let itemChk = itemGrpX.length <= 0 || itemGrpY.length <= 0

        // let groupBy = this.groupBy ? this.inputs[this.groupBy].itemGrp : []
        // let itemGrpChk = groupBy.length > 0

        if (itemChk) {
          // if (!itemGrpChk) {
            return false;
          // }
        }

        //"itemChk" for avoid error from chart
        // itemChk = itemChk ? !itemGrpChk : itemChk
        let parseDate = d3.time.format('%Y-%m-%d').parse;
        let width = +this.settings.width.value,
            height = 50,
            margin = {top: 5, right: 40, bottom: 20, left: 120}
            //margin = {top: +this.settings.margin.value.top, right: +this.settings.margin.value.right, bottom: +this.settings.margin.value.bottom, left: +this.settings.margin.value.left}
        width = width - margin.left - margin.right
        height = height - margin.top - margin.bottom

        let color = d3.scale.category20c();

        //get chart data once pass "itemGrp" into the "getChartData" method
        let itemGrp = itemGrpX.concat.apply(itemGrpX, itemGrpY)
        // itemGrp = itemGrpChk ? groupBy : itemGrpX.concat.apply(itemGrpX, itemGrpY)

        let groupedData
        let source = this.getChartData(itemGrp)
        // debugger
        // groupedData = d3.nest().key(d => d.item).entries(source);
// debugger
        let chartSrcData = source.map((item,i)=>{ if(i%2) return {
          "item":source[i-1].value,"date":item.value}
        }).filter((items,i)=>{
          return items
        })

        let chartData = d3.nest()
              .key((d)=> parseDate(d.date.split(' ')[0]))
              .rollup(function (n) {
                  return d3.sum(n, function (d) {
                      return d.item; // key
                  })
              })
              .map(chartSrcData);;

        return {
          width,
          height,
          color,
          //chart,
          margin,
          itemChk,
          chartData
        }

      }
      _paint(obj) {
        d3.select(this.$.chartContainer).html("")
        if (!obj || obj.itemChk) {
          return false
        }
      }
    }
    customElements.define(calendarChart.is,calendarChart)
  </script>
</dom-module>
