<link rel="import" href="../display-component/base-chart.html">
<dom-module id='calendar-chart'>
  <template>
  <style>
  .day {
    fill: #fff;
    stroke: black;
    stroke-width: .5px;
  }
  .month {
    fill: none;
    stroke: white;
    stroke-width: 1px;
  }
  .year-title {
    font-size: 18px;
    letter-spacing: 10px;
    fill: #00B0DD;
  }
  #info {
  position: absolute;
  top: 10px;
  left: 40px;
  font-size: 13px;
  }
  header {
  position: fixed;
  left: 0;
  top: 0;
  height: 33px;
  width: 100%;
  background: #ffff00;
  opacity: 0.9;
  z-index: 22;
  background: #00B0DD;
  color: white;
  }
  svg text {
    font-size: 11px;
    text-transform: uppercase;
    fill: #00B0DD;
  }
  #chartContainer{
    margin:0 auto;
  }
  </style>
    <chart-input-group  uuid="[[uuid]]">
      <chart-input slot="chart-input" axis="x" label="Key" accept="date"></chart-input>
      <chart-input slot="chart-input" axis="y" label="Value" accept="number"></chart-input>
    </chart-input-group>
    <chart-settings uuid="[[uuid]]"></chart-settings>
    <!-- <svg id="svg"></svg> -->
    <div id="chartContainer"></div>
  </template>

  <script>
    class calendarChart extends baseChart{
      static get is(){
        return "calendar-chart"
      }
      static get properties(){
        return{

        }
      }
      constructor(){
        super()
      }
      redraw() {
        this.draw(this._paint(this._compute()));
      }
      _compute() {
        //axis are mentioned in the chart-input module
        let itemX = this.x ? this.inputs[this.x].selectedValue : []
        let itemY = this.y ? this.inputs[this.y].selectedValue : []

        //"itemChk" for avoid error from chart
        let itemChk = itemX.length <= 0 || itemY.length <= 0

        if (itemChk) {
            return false;
        }
        //axis inputs selectedValue assigin
        itemX = itemX[0]
        itemY=itemY[0]

        let parseDate = d3.time.format('%Y-%m-%d').parse;
        let width = +this.settings.width.value,
            height = +this.settings.height.value,
            margin = {top: 5, right: 40, bottom: 20, left: 120}
            //margin = {top: +this.settings.margin.value.top, right: +this.settings.margin.value.right, bottom: +this.settings.margin.value.bottom, left: +this.settings.margin.value.left}
        let color = d3.scale.category20c();

        //get chart data once pass "x and y" into the "getChartData" method
        let source = this.getChartData(itemX, itemY)
        let chartSrcData = source.map((item,i)=>{
          return{"item":item.value,"date":item["item"]}
        })
        // debugger
        let chartData = d3.nest()
              .key((d)=> parseDate(d.item.split(' ')[0]))
              .rollup(function (n) {
                  return d3.sum(n, function (d) {
                      return d.value; // key
                  })
              })
              .map(source);
        //get years and calculated for year range(start and end year)
        let yearRange = chartSrcData.map(date=>+date.date.split("-")[0]).sort((a, b)=> a-b)
        let startYear =yearRange[0]
        let endYear =yearRange.pop()+1


        // create chart and source available in calendar-heatmap.js
        let self = this
        let calendarChart = d3.calendar.heatmap()
            .colourRangeStart('#FDBB30')
            .colourRangeEnd('#EE3124')
            .height(height)
            .width(width)
            .startYear(startYear)
            .endYear(endYear)
            .margin(margin)

        return {
          width,
          calendarChart,
          itemChk,
          chartData
        }

      }
      _paint(obj) {
        d3.select(this.$.chartContainer).html("")
        if (!obj || obj.itemChk) {
          return false
        }
        // render chart

        d3.select(this.$.chartContainer)
          .datum(obj.chartData)
          .call(obj.calendarChart);

        d3.select(this.$.chartContainer).style({"width":obj.width+"px"})
      }
      // populate chart data
      getChartData(itemX, itemY){
          let sourcemap = this.source.map(row=>{
            return{[row[itemX]]:row[itemY]}
          })
          // debugger
          let source  = sourcemap.map(items=>{return {item:Object.keys(items)[0],value:items[Object.keys(items)[0]]}})
          return source
      }
    }
    customElements.define(calendarChart.is,calendarChart)
  </script>
  <script src="calendar-heatmap.js"></script>
</dom-module>
