<!--
A polymer wrapper for Dragula: 'Drag and drop so simple it hurts'
https://github.com/bevacqua/dragula
-->

<dom-module id="polymer-dragula">
  <template>
    <style>
      :host {
        display: block;
      }
      #main-container {
        background-color: grey;
        margin: 0px 15px;
        padding: 8px;
      }
      #main-container paper-icon-button {
        display: none;
      }
      span.drag-rect {
        background-color: aliceblue;
        cursor: copy;
        display: inline-block;
        padding: 6px;
        position: relative;
        text-align: left;
        width: 100px;
      }
      span.drag-rect paper-icon-button {
        height: 33px;
        right: 5px;
        position: absolute;
        top: 0;
      }
      .dragbox-wrap {
        display: inline-block;
      }
      .dragbox-wrap .child-container {
        background: #ededed;
        border-radius: 2px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        display: inline-block;
        height: 180px;
        margin: 1em;
        overflow-y: auto;
        padding: .5em;
        vertical-align: bottom;
        width: 180px;
      }
      .dragbox-wrap .child-container span.drag-rect {
        cursor: move;
        margin-bottom: 5px;
      }
    </style>
    <div id="main-container">
      <template
        is="dom-repeat"
        items={{externals}}
        as=item
        index-as=index>
        <span class="drag-rect">
          {{item.key}}
          <paper-icon-button on-tap="_delete" icon="icons:delete" class="del"></paper-icon-button>
        </span>
      </template>
    </div>
    <div id="inputWrap">
      <template is="dom-repeat" items="{{inputs}}" as="input" index-as="inputIndex">
        <!-- Colors -->
        <div class="dragbox-wrap">
          <h4>
            {{input.txt}}
          </h4>
          <div class$="child-container sortable-wrap {{input.supportedTypes}}">
            <template is="dom-repeat"
              items={{input.selectedObjs}}
              as="selectedItem">
              <span class="drag-rect">
                {{selectedItem.key}}
                <paper-icon-button on-tap="_delete" icon="icons:delete" class="del"></paper-icon-button>
              </span>
            </template>
          </div>
        </div>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: 'polymer-dragula',
      properties: {
        inputs: {
          value: () => { return [];},
          notify: true,
          type: Array
        },
        externals: {
          value: () => { return [];},
          notify: true,
          type: Array
        },
        draggables: {
          type: Object,
          value: () => { return {};}
        },
        slaves: {
          type: Array,
          value: () => { return [];}
        }
      },

      observers: ['_inputsObserver(inputs)'],

      _inputsObserver: function(inputs) {
        let MASTER_ID = '#main-container';
        let me = this; // for querySelectorAll at dragula copy
        if (inputs.length && inputs.length > 0) {
          this.async(() => {
            this.draggables = dragula({
              copy: function(el, source) {
                return source === me.querySelector(MASTER_ID); // copy only from master
              },
              accepts: function (el, target) {
                return target !== me.querySelector(MASTER_ID);
              }
            });
            this.draggables.containers.push(this.querySelector(MASTER_ID));

            let draggables = this.querySelectorAll('.child-container');
            [].forEach.call(draggables, elem => { // attach child elements to dragula
              this.draggables.containers.push(elem);
            });
          }, 1000);
        }
      },

      _delete: function(e) {
        console.log(e);
      }
    });
  </script>
</dom-module>